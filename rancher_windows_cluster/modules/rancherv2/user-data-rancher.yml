#cloud-config

users:  
  - default 
  - name: rancher    
    gecos: rancher    
    primary_group: rancher    
    sudo: ALL=(ALL) NOPASSWD:ALL    
    groups: users, admin
    lock_passwd: false    
    ssh_authorized_keys:
      - 
    
package_update: true

runcmd:
  # - TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
  # - publicIP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/public-ipv4)
  # - privateIP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/local-ipv4)
  - "bash -c 'curl https://get.k3s.io | INSTALL_K3S_EXEC=\"server --node-external-ip ${public_ip} --node-ip ${private_ip}\" INSTALL_K3S_VERSION=${k8s_version} sh -'"
  - sudo sed \"s/127.0.0.1/${public_ip}/g\" /etc/rancher/k3s/k3s.yaml
  # - "bash -c 'curl https://get.k3s.io | INSTALL_K3S_EXEC=\"server --node-external-ip $publicIP --node-ip $privateIP\" INSTALL_K3S_VERSION=${var.rancher_kubernetes_version} sh -'"
  # - ${cluster_registration} --address $publicIP --internal-address $privateIP
  # - ${cluster_registration}